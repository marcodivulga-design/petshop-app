<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Petshop + Vet (V3)</title>

<style>
:root{
  --bg:#F5F1EB; --card:#FFFFFF; --text:#2E2E2E; --muted:#6B6B6B;
  --primary:#4CAF8F; --secondary:#6FA8DC; --danger:#C97A5B;
  --border:#E6E0D8; --radius:14px; --shadow:0 6px 16px rgba(0,0,0,.08);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:78px}
header{padding:16px;font-weight:850;font-size:18px}
section{padding:12px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);padding:14px;margin-bottom:12px}
h3{margin:0 0 10px 0}
label{display:block;margin-top:8px;font-size:12px;color:var(--muted)}
input,textarea,select{
  width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid var(--border);
  font-size:14px;background:#fff;box-sizing:border-box;
}
textarea{min-height:80px;resize:vertical}
button{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-size:14px}
.primary{background:var(--primary);color:#fff}
.secondary{background:var(--secondary);color:#fff}
.danger{background:var(--danger);color:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:140px}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.list-item{padding:10px;border-bottom:1px solid var(--border)}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted);margin-left:6px}
nav{
  position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);
  display:flex;z-index:999
}
nav button{flex:1;background:none;border:none;padding:10px 0;font-size:12px}
nav button.active{color:var(--primary);font-weight:850}
.hidden{display:none}
.avatar{
  width:64px;height:64px;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#fff
}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi > div{flex:1;min-width:150px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
.kpi b{font-size:18px}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;border:1px solid var(--border);
  font-size:12px;color:var(--muted);
}
.dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
.dot.green{background:var(--primary)}
.dot.blue{background:var(--secondary)}
.dot.red{background:var(--danger)}
.dot.gray{background:var(--muted)}
</style>
</head>

<body>
<header id="title">Painel</header>
<section id="screen"></section>
<nav id="nav"></nav>

<script>
/** ======================
 * FEATURES / PLANS (bloqueio/desbloqueio)
 * ====================== */
const FEATURES = {
  CLIENTS: "CLIENTS",
  AGENDA: "AGENDA",
  VET: "VET",
  PDF: "PDF",
  WHATSAPP: "WHATSAPP",
  PRODUCTS: "PRODUCTS",
  STOCK_ALERT: "STOCK_ALERT",
  CASH: "CASH",
  HOTEL: "HOTEL",
  COMMISSION: "COMMISSION",
  PORTAL: "PORTAL",
  MULTISHOP: "MULTISHOP",
  LOGIN: "LOGIN",
  GROOMING_FLOW: "GROOMING_FLOW",
  TERMS: "TERMS"
};

const PLANS = {
  START: {
    name: "START",
    label: "Start",
    allow: [FEATURES.CLIENTS, FEATURES.AGENDA, FEATURES.PRODUCTS, FEATURES.PORTAL]
  },
  PRO: {
    name: "PRO",
    label: "Pro",
    allow: [
      FEATURES.CLIENTS, FEATURES.AGENDA, FEATURES.PRODUCTS, FEATURES.PORTAL,
      FEATURES.VET, FEATURES.PDF, FEATURES.WHATSAPP
    ]
  },
  PLUS: {
    name: "PLUS",
    label: "Plus",
    allow: [
      FEATURES.CLIENTS, FEATURES.AGENDA, FEATURES.PRODUCTS, FEATURES.PORTAL,
      FEATURES.VET, FEATURES.PDF, FEATURES.WHATSAPP,
      FEATURES.HOTEL, FEATURES.CASH, FEATURES.STOCK_ALERT, FEATURES.COMMISSION,
      FEATURES.GROOMING_FLOW
    ]
  },
  MASTER: {
    name: "MASTER",
    label: "Master",
    allow: Object.values(FEATURES)
  }
};

function activePlan(){
  const key = DB.plan || "START";
  return PLANS[key] || PLANS.START;
}
function has(feature){ return activePlan().allow.includes(feature); }

function upgradeScreen(feature, msg){
  const p = activePlan();
  $("title").innerText = "Upgrade";
  $("screen").innerHTML = `
    <div class="card">
      <h3>Fun√ß√£o bloqueada</h3>
      <div class="small">${msg || "Essa fun√ß√£o faz parte de um pacote superior."}</div>
      <hr>
      <div class="small">
        Seu plano atual: <b>${p.label}</b><br>
        Quer liberar isso? Troca o plano na hora (modo demonstra√ß√£o) ou vende o upgrade.
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="primary" onclick="show('home')">Voltar</button>
        <button class="secondary" onclick="demoUnlock()">Desbloquear (demo)</button>
      </div>
      <hr>
      <div class="small">
        Dica de venda: ‚ÄúNo ${PLANS.PRO.label} entra Vet + Receita. No ${PLANS.PLUS.label} entra Hotel + Caixa + Fila Banho/Tosa. No ${PLANS.MASTER.label} entra multi-loja e login.‚Äù
      </div>
    </div>
  `;
  setActiveNone();
}
function demoUnlock(){
  // modo demo: sobe um n√≠vel at√© liberar geral
  const k = DB.plan || "START";
  DB.plan = (k==="START") ? "PRO" : (k==="PRO") ? "PLUS" : "MASTER";
  save();
  renderNav();
  show("home");
}
function guard(feature, msg){
  if(has(feature)) return true;
  upgradeScreen(feature, msg);
  return false;
}

/** ======================
 * DB + helpers
 * ====================== */
const DEFAULT_DB = {
  plan: "PLUS", // <-- mude aqui para START/PRO/PLUS/MASTER antes de vender
  auth: { enabled:false, pass:"1234" }, // login s√≥ se MASTER (voc√™ ativa l√°)
  __logged: false,

  shops: [{id:1,name:"Minha Loja",phone:""}],
  currentShopId: 1,

  clients: [],
  pets: [],
  agenda: [],
  products: [],
  vetRecords: [],
  vaccines: [],
  boardings: [],
  sales: [],
  cashflow: [],

  grooming: [] // fila banho/tosa {id, petId, type, status, createdAt, note}
};

const DB = loadDB();
function loadDB(){
  try{
    const raw = localStorage.getItem("petdb_v3");
    if(!raw) return structuredClone(DEFAULT_DB);
    const parsed = JSON.parse(raw);
    return {...structuredClone(DEFAULT_DB), ...parsed,
      auth: parsed.auth || structuredClone(DEFAULT_DB.auth),
      shops: parsed.shops || structuredClone(DEFAULT_DB.shops),
      vaccines: parsed.vaccines || [],
      boardings: parsed.boardings || [],
      sales: parsed.sales || [],
      cashflow: parsed.cashflow || [],
      grooming: parsed.grooming || []
    };
  }catch(e){ return structuredClone(DEFAULT_DB); }
}
function save(){ localStorage.setItem("petdb_v3", JSON.stringify(DB)); }

const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const idNow = ()=> Date.now() + Math.floor(Math.random()*1000);
const todayISO = ()=> new Date().toISOString().slice(0,10);

function fmt(n){
  n = Number(n||0);
  return n.toFixed(2).replace(".",",");
}
function currentShop(){ return DB.shops.find(s=>s.id===DB.currentShopId) || DB.shops[0]; }
function shopFilter(arr){ return arr.filter(x=> (x.shopId ?? DB.currentShopId)===DB.currentShopId ); }
function petName(petId){ const p = DB.pets.find(p=>p.id===petId); return p ? p.name : "Pet"; }
function waOpen(phone, text){
  const clean = String(phone||"").replace(/\D/g,"");
  window.open(`https://wa.me/55${clean}?text=${encodeURIComponent(text||"")}`, "_blank");
}

/** ======================
 * NAV (din√¢mico por plano)
 * ====================== */
function renderNav(){
  const nav = $("nav");
  const btn = (id,label)=>`<button onclick="show('${id}')" id="b_${id}">${label}</button>`;

  nav.innerHTML = `
    ${btn("home","Home")}
    ${has(FEATURES.CLIENTS) ? btn("clients","Clientes") : ""}
    ${has(FEATURES.AGENDA) ? btn("agenda","Agenda") : ""}
    ${has(FEATURES.GROOMING_FLOW) ? btn("groom","Banho/Tosa") : ""}
    ${has(FEATURES.VET) ? btn("vet","Vet") : ""}
    ${has(FEATURES.HOTEL) ? btn("hotel","Hotel") : ""}
    ${has(FEATURES.CASH) ? btn("cash","Caixa") : ""}
    ${has(FEATURES.PORTAL) ? btn("portal","Portal") : ""}
  `;
}

function setActive(tab){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  const btn = $("b_"+tab);
  if(btn) btn.classList.add("active");
}
function setActiveNone(){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
}
function setTitle(tab){
  const shop = currentShop();
  const p = activePlan();
  $("title").innerText = ({
    home:"Painel",
    clients:"Clientes e Pets",
    agenda:"Agenda + Vacinas",
    groom:"Fila Banho/Tosa",
    vet:"Veterin√°rio",
    hotel:"Hotelzinho / Creche",
    cash:"Caixa / Vendas",
    portal:"Portal do Tutor"
  }[tab] || "Painel") + ` ‚Ä¢ ${shop.name} ‚Ä¢ ${p.label}`;
}

/** ======================
 * LOGIN (somente MASTER)
 * ====================== */
function loginScreen(){
  $("title").innerText = "Entrar";
  $("screen").innerHTML = `
    <div class="card">
      <h3>Senha</h3>
      <input id="lpass" type="password" placeholder="Digite a senha">
      <div class="actions">
        <button class="primary" onclick="doLogin()">Entrar</button>
      </div>
      <hr>
      <div class="small">Senha padr√£o: <b>1234</b>. Troque nas Configura√ß√µes.</div>
    </div>
  `;
}
function doLogin(){
  const p = $("lpass").value;
  if(p !== DB.auth.pass) return alert("Senha errada.");
  DB.__logged = true; save();
  show("home");
}
function mustLogin(){
  if(!has(FEATURES.LOGIN)) return false; // sem login fora do master
  if(!DB.auth.enabled) return false;
  return !DB.__logged;
}

/** ======================
 * ROUTER
 * ====================== */
function show(tab){
  if(mustLogin()) return loginScreen();

  if(tab==="clients" && !guard(FEATURES.CLIENTS, "Clientes/Pets est√° no START ou acima.")) return;
  if(tab==="agenda" && !guard(FEATURES.AGENDA, "Agenda est√° no START ou acima.")) return;
  if(tab==="vet" && !guard(FEATURES.VET, "Veterin√°rio √© PRO ou acima.")) return;
  if(tab==="hotel" && !guard(FEATURES.HOTEL, "Hotelzinho √© PLUS ou acima.")) return;
  if(tab==="cash" && !guard(FEATURES.CASH, "Caixa √© PLUS ou acima.")) return;
  if(tab==="portal" && !guard(FEATURES.PORTAL, "Portal do tutor √© START ou acima.")) return;
  if(tab==="groom" && !guard(FEATURES.GROOMING_FLOW, "Fila Banho/Tosa √© PLUS ou acima.")) return;

  renderNav();
  setActive(tab);
  setTitle(tab);
  const s=$("screen"); s.innerHTML="";

  if(tab==="home") return home();
  if(tab==="clients") return clients();
  if(tab==="agenda") return agenda();
  if(tab==="groom") return groom();
  if(tab==="vet") return vet();
  if(tab==="hotel") return hotel();
  if(tab==="cash") return cash();
  if(tab==="portal") return portal();
}

/** ======================
 * HOME
 * ====================== */
function home(){
  const clients = shopFilter(DB.clients);
  const pets = shopFilter(DB.pets);
  const agenda = shopFilter(DB.agenda);
  const boardings = shopFilter(DB.boardings);
  const sales = shopFilter(DB.sales);
  const grooming = shopFilter(DB.grooming);
  const products = shopFilter(DB.products);

  const upcoming = agenda.slice().sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time)).slice(0,5);
  const todaySales = sales.filter(s=>s.date===todayISO()).reduce((acc,s)=>acc+Number((s.total||"0").replace(".","").replace(",",".")||0),0);

  const lowStock = has(FEATURES.STOCK_ALERT)
    ? products.filter(p=>{
        const qty = Number((p.qty||"0").replace(",","."));
        const min = Number((p.min||"0").replace(",","."));
        return !isNaN(qty) && !isNaN(min) && qty <= min;
      }).slice(0,6)
    : [];

  $("screen").innerHTML = `
    <div class="card">
      <h3>Plano e Loja</h3>
      <div class="row">
        <div>
          <label>Plano</label>
          <select id="planSel">
            ${Object.keys(PLANS).map(k=>`<option value="${k}" ${(DB.plan||"START")===k?"selected":""}>${PLANS[k].label}</option>`).join("")}
          </select>
        </div>
        <div>
          <label>Loja</label>
          <select id="shopSel" onchange="switchShop()">
            ${DB.shops.map(s=>`<option value="${s.id}" ${s.id===DB.currentShopId?"selected":""}>${esc(s.name)}</option>`).join("")}
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="primary" onclick="setPlan()">Aplicar plano</button>
        <button class="secondary" onclick="addShopGuarded()">Adicionar loja</button>
        <button class="secondary" onclick="settings()">Configura√ß√µes</button>
      </div>
      <div class="small">Vende assim: voc√™ troca o plano na frente do cliente e ‚Äúdesbloqueia‚Äù as fun√ß√µes.</div>
    </div>

    <div class="card">
      <h3>Resumo</h3>
      <div class="kpi">
        <div><div class="small">Clientes</div><b>${clients.length}</b></div>
        <div><div class="small">Pets</div><b>${pets.length}</b></div>
        <div><div class="small">Agendamentos</div><b>${agenda.length}</b></div>
        ${has(FEATURES.GROOMING_FLOW) ? `<div><div class="small">Fila Banho/Tosa</div><b>${grooming.filter(g=>g.status!=="Entregue").length}</b></div>` : ``}
        ${has(FEATURES.HOTEL) ? `<div><div class="small">No hotel</div><b>${boardings.filter(b=>b.status==="Ativo").length}</b></div>` : ``}
        ${has(FEATURES.CASH) ? `<div><div class="small">Vendas hoje</div><b>R$ ${fmt(todaySales)}</b></div>` : ``}
      </div>
    </div>

    ${has(FEATURES.STOCK_ALERT) ? `
      <div class="card">
        <h3>Alertas de estoque</h3>
        ${lowStock.length ? lowStock.map(p=>`
          <div class="list-item">
            <b>${esc(p.name)}</b>
            <span class="badge">Qtd ${esc(p.qty||"0")}</span>
            <span class="badge">M√≠n ${esc(p.min||"0")}</span>
          </div>
        `).join("") : `<div class="small">Tudo ok no estoque.</div>`}
      </div>
    ` : ``}

    <div class="card">
      <h3>Pr√≥ximos</h3>
      ${upcoming.length ? upcoming.map(a=>{
        const pet = pets.find(p=>p.id===a.petId);
        const client = pet ? clients.find(c=>c.id===pet.clientId) : null;
        return `
          <div class="list-item">
            <b>${esc(a.type)}</b> <span class="badge">${esc(a.date)} ${esc(a.time||"")}</span><br>
            <span class="small">${esc(pet?.name || "Pet")} ‚Ä¢ ${esc(client?.name || "Tutor")}</span>
          </div>
        `;
      }).join("") : `<div class="small">Nada agendado ainda.</div>`}
    </div>

    <div class="card">
      <h3>Backup r√°pido</h3>
      <div class="small">Copia e guarda. Se der ruim, restaura.</div>
      <textarea readonly>${esc(JSON.stringify(DB))}</textarea>
      <div class="actions">
        <button class="secondary" onclick="downloadBackup()">Baixar backup</button>
        <button class="danger" onclick="resetAll()">Zerar tudo</button>
      </div>
    </div>
  `;
}
function setPlan(){
  DB.plan = $("planSel").value;
  save();
  renderNav();
  show("home");
}
function switchShop(){
  DB.currentShopId = Number($("shopSel").value);
  save(); show("home");
}
function addShopGuarded(){
  if(!guard(FEATURES.MULTISHOP, "Multi-loja √© MASTER.")) return;
  addShop();
}
function addShop(){
  const name = prompt("Nome da loja:");
  if(!name) return;
  const phone = prompt("Telefone (opcional):") || "";
  const id = idNow();
  DB.shops.push({id,name,phone});
  DB.currentShopId = id;
  save();
  show("home");
}
function settings(){
  const canLogin = has(FEATURES.LOGIN);
  $("title").innerText = "Configura√ß√µes";
  setActiveNone();

  $("screen").innerHTML = `
    <div class="card">
      <h3>Configura√ß√µes</h3>

      <div class="small">Plano atual: <b>${activePlan().label}</b></div>
      <hr>

      <h3 style="margin:0 0 10px 0">Login</h3>
      ${canLogin ? `
        <div class="small">Somente no plano MASTER.</div>
        <label>Ativar login</label>
        <select id="authOn">
          <option value="0" ${DB.auth.enabled? "":"selected"}>Desligado</option>
          <option value="1" ${DB.auth.enabled? "selected":""}>Ligado</option>
        </select>
        <label>Senha atual</label>
        <input id="curPass" type="password" placeholder="Senha atual">
        <label>Nova senha</label>
        <input id="newPass" type="password" placeholder="Nova senha">
        <div class="actions">
          <button class="primary" onclick="applyAuth()">Aplicar</button>
        </div>
      ` : `
        <div class="small">Login est√° dispon√≠vel no plano MASTER.</div>
      `}
      <hr>

      <div class="actions">
        <button class="secondary" onclick="show('home')">Voltar</button>
      </div>
    </div>
  `;
}
function applyAuth(){
  const on = $("authOn").value==="1";
  DB.auth.enabled = on;

  const cur = $("curPass").value;
  const np = $("newPass").value.trim();
  if(np){
    if(cur !== DB.auth.pass) return alert("Senha atual errada.");
    if(np.length < 4) return alert("Use 4+ caracteres.");
    DB.auth.pass = np;
  }
  DB.__logged = false;
  save();
  alert("Ok.");
  show("home");
}
function downloadBackup(){
  const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "petdb-v3-backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function resetAll(){
  if(!confirm("Tem certeza? Apaga tudo deste navegador.")) return;
  localStorage.removeItem("petdb_v3");
  location.reload();
}

/** ======================
 * CLIENTS + PETS + FOTO
 * ====================== */
let __petPhotoB64 = "";

function clients(){
  const clients = shopFilter(DB.clients).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  const pets = shopFilter(DB.pets);

  $("screen").innerHTML = `
    <div class="card">
      <h3>Novo cliente</h3>
      <label>Nome</label><input id="cname" placeholder="Ex: Jo√£o Silva">
      <label>Telefone</label><input id="cphone" placeholder="Ex: 6799999-9999">
      <div class="actions"><button class="primary" onclick="addClient()">Salvar</button></div>
    </div>

    <div class="card">
      <h3>Novo pet</h3>
      <label>Tutor</label>
      <select id="petOwner">
        ${clients.length ? clients.map(c=>`<option value="${c.id}">${esc(c.name)} ‚Ä¢ ${esc(c.phone||"")}</option>`).join("") : `<option value="">Cadastre um cliente primeiro</option>`}
      </select>
      <label>Nome do pet</label><input id="petName" placeholder="Ex: Thor">
      <div class="row">
        <div><label>Esp√©cie</label><select id="petSpecies"><option>C√£o</option><option>Gato</option><option>Outro</option></select></div>
        <div><label>Ra√ßa</label><input id="petBreed" placeholder="Ex: SRD"></div>
      </div>
      <div class="row">
        <div><label>Nascimento</label><input id="petBirth" type="date"></div>
        <div><label>Alergias</label><input id="petAllergy" placeholder="Ex: frango"></div>
      </div>
      <label>Foto do pet</label>
      <input id="petPhoto" type="file" accept="image/*" onchange="previewPetPhoto()">
      <div class="row" style="align-items:center;margin-top:10px">
        <img id="petPreview" class="avatar" alt="">
        <div class="small">Foto vira carteirinha e d√° confian√ßa.</div>
      </div>
      <label>Observa√ß√µes</label><input id="petNotes" placeholder="Temperamento, cuidados, etc">
      <div class="actions"><button class="primary" onclick="addPet()">Salvar pet</button></div>
    </div>

    ${clients.map(c=>{
      const cpets = pets.filter(p=>p.clientId===c.id);
      return `
        <div class="card">
          <b>${esc(c.name)}</b> <span class="badge">${esc(c.phone||"")}</span><br>
          <span class="small">${cpets.length} pet(s)</span>

          ${cpets.length ? `<hr>` : ``}

          ${cpets.map(p=>`
            <div class="list-item">
              <div class="row" style="align-items:center">
                <img class="avatar" src="${p.photo||""}" alt="" onerror="this.style.display='none'">
                <div>
                  <b>${esc(p.name)}</b> <span class="badge">${esc(p.species||"")}</span><br>
                  <span class="small">${esc(p.breed||"")} ${p.allergy ? "‚Ä¢ alergia: "+esc(p.allergy) : ""}</span>
                </div>
              </div>
              <div class="actions">
                ${has(FEATURES.VET) ? `<button class="secondary" onclick="goVet(${p.id})">Ficha/Receita</button>` : `<button class="secondary" onclick="upgradeScreen('${FEATURES.VET}','Veterin√°rio √© PRO ou acima.')">Ficha/Receita</button>`}
                ${has(FEATURES.GROOMING_FLOW) ? `<button class="secondary" onclick="quickGroom(${p.id})">Fila Banho/Tosa</button>` : ``}
                ${has(FEATURES.HOTEL) ? `<button class="secondary" onclick="goHotel(${p.id})">Hotelzinho</button>` : ``}
                <button class="danger" onclick="delPet(${p.id})">Excluir pet</button>
              </div>
            </div>
          `).join("")}

          <div class="actions">
            <button class="danger" onclick="delClient(${c.id})">Excluir cliente</button>
            ${c.phone ? `<button class="secondary" onclick="waOpen('${esc(c.phone)}','Ol√°! üòä')">WhatsApp tutor</button>` : ``}
          </div>
        </div>
      `;
    }).join("")}
  `;
}
function addClient(){
  const name = $("cname").value.trim();
  const phone = $("cphone").value.trim();
  if(!name) return alert("Coloque o nome.");
  DB.clients.push({id:idNow(), shopId:DB.currentShopId, name, phone});
  save(); show("clients");
}
function previewPetPhoto(){
  const f = $("petPhoto").files?.[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ __petPhotoB64 = r.result; $("petPreview").src = __petPhotoB64; };
  r.readAsDataURL(f);
}
function addPet(){
  const owner = Number($("petOwner").value);
  if(!owner) return alert("Cadastre um cliente primeiro.");
  const name = $("petName").value.trim();
  if(!name) return alert("Nome do pet, por favor.");

  DB.pets.push({
    id:idNow(), shopId:DB.currentShopId,
    clientId:owner,
    name,
    species:$("petSpecies").value,
    breed:$("petBreed").value.trim(),
    birth:$("petBirth").value,
    allergy:$("petAllergy").value.trim(),
    notes:$("petNotes").value.trim(),
    photo: __petPhotoB64 || ""
  });
  __petPhotoB64 = "";
  save(); show("clients");
}
function delClient(clientId){
  if(!confirm("Excluir cliente e tudo ligado a ele?")) return;
  const myPets = shopFilter(DB.pets).filter(p=>p.clientId===clientId).map(p=>p.id);

  DB.clients = DB.clients.filter(c=>c.id!==clientId);
  DB.pets = DB.pets.filter(p=>p.clientId!==clientId);
  DB.agenda = DB.agenda.filter(a=> !myPets.includes(a.petId));
  DB.vetRecords = DB.vetRecords.filter(v=> !myPets.includes(v.petId));
  DB.vaccines = DB.vaccines.filter(v=> !myPets.includes(v.petId));
  DB.boardings = DB.boardings.filter(b=> !myPets.includes(b.petId));
  DB.grooming = DB.grooming.filter(g=> !myPets.includes(g.petId));

  save(); show("clients");
}
function delPet(petId){
  if(!confirm("Excluir pet e hist√≥rico dele?")) return;

  DB.pets = DB.pets.filter(p=>p.id!==petId);
  DB.agenda = DB.agenda.filter(a=>a.petId!==petId);
  DB.vetRecords = DB.vetRecords.filter(v=>v.petId!==petId);
  DB.vaccines = DB.vaccines.filter(v=>v.petId!==petId);
  DB.boardings = DB.boardings.filter(b=>b.petId!==petId);
  DB.grooming = DB.grooming.filter(g=>g.petId!==petId);

  save(); show("clients");
}

/** ======================
 * AGENDA + VACINAS
 * ====================== */
function agenda(){
  const pets = shopFilter(DB.pets);
  const clients = shopFilter(DB.clients);
  const items = shopFilter(DB.agenda).slice().sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
  const vac = shopFilter(DB.vaccines).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  $("screen").innerHTML = `
    <div class="card">
      <h3>Novo agendamento</h3>
      <label>Tipo</label>
      <select id="atype">
        <option>Banho</option><option>Tosa</option><option>Banho + Tosa</option>
        <option>Consulta Veterin√°ria</option><option>Vacina</option><option>Retorno</option><option>Hotelzinho</option>
      </select>
      <label>Pet</label>
      <select id="apetId">
        ${pets.length ? pets.map(p=>{
          const c = clients.find(x=>x.id===p.clientId);
          return `<option value="${p.id}">${esc(p.name)} ‚Ä¢ ${esc(c?.name||"Tutor")}</option>`;
        }).join("") : `<option value="">Cadastre um pet primeiro</option>`}
      </select>
      <div class="row">
        <div><label>Data</label><input type="date" id="adate" value="${todayISO()}"></div>
        <div><label>Hora</label><input type="time" id="atime"></div>
      </div>
      <label>Obs</label><input id="aobs" placeholder="Ex: levar carteirinha">
      <div class="actions"><button class="primary" onclick="addAgenda()">Salvar</button></div>
      ${has(FEATURES.GROOMING_FLOW) ? `<div class="small" style="margin-top:10px">Dica: se for Banho/Tosa, voc√™ pode jogar direto na fila.</div>` : ``}
    </div>

    <div class="card">
      <h3>Vacinas (carteirinha)</h3>
      <label>Pet</label>
      <select id="vpetVac">
        ${pets.length ? pets.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join("") : `<option value="">Cadastre um pet</option>`}
      </select>
      <label>Vacina</label>
      <input id="vname" placeholder="Ex: V10, Antirr√°bica">
      <div class="row">
        <div><label>Data</label><input id="vdate" type="date" value="${todayISO()}"></div>
        <div><label>Pr√≥xima</label><input id="vnext" type="date"></div>
      </div>
      <label>Obs</label><input id="vobs" placeholder="Lote, rea√ß√£o, etc">
      <div class="actions"><button class="primary" onclick="addVaccine()">Salvar vacina</button></div>

      <hr>
      ${vac.length ? vac.slice(0,8).map(v=>{
        return `
          <div class="list-item">
            <b>${esc(v.name)}</b> <span class="badge">${esc(v.date||"")}</span>
            ${v.nextDate ? `<span class="badge">Pr√≥xima: ${esc(v.nextDate)}</span>` : ``}
            <div class="small">${esc(petName(v.petId))}${v.obs ? " ‚Ä¢ "+esc(v.obs) : ""}</div>
            <div class="actions"><button class="danger" onclick="delVaccine(${v.id})">Excluir</button></div>
          </div>
        `;
      }).join("") : `<div class="small">Sem vacinas registradas.</div>`}
    </div>

    <div class="card">
      <h3>Agendamentos</h3>
      ${items.length ? items.map(a=>{
        const p = pets.find(x=>x.id===a.petId);
        const c = p ? clients.find(x=>x.id===p.clientId) : null;
        return `
          <div class="list-item">
            <b>${esc(a.type)}</b> <span class="badge">${esc(a.date)} ${esc(a.time||"")}</span><br>
            <span class="small">${esc(p?.name||"")} ‚Ä¢ ${esc(c?.name||"")}</span>
            ${a.obs ? `<div class="small">${esc(a.obs)}</div>` : ``}
            <div class="actions">
              ${has(FEATURES.VET) ? `<button class="secondary" onclick="goVet(${a.petId})">Ficha</button>` : ``}
              ${has(FEATURES.GROOMING_FLOW) && /Banho|Tosa/i.test(a.type) ? `<button class="secondary" onclick="quickGroom(${a.petId}, '${esc(a.type)}')">Jogar na fila</button>` : ``}
              <button class="danger" onclick="delAgenda(${a.id})">Excluir</button>
            </div>
          </div>
        `;
      }).join("") : `<div class="small">Agenda vazia.</div>`}
    </div>
  `;
}
function addAgenda(){
  const petId = Number($("apetId").value);
  if(!petId) return alert("Selecione um pet.");
  const date = $("adate").value;
  if(!date) return alert("Data obrigat√≥ria.");

  DB.agenda.push({
    id:idNow(), shopId:DB.currentShopId,
    type:$("atype").value, petId, date,
    time:$("atime").value,
    obs:$("aobs").value.trim()
  });
  save(); show("agenda");
}
function delAgenda(id){
  if(!confirm("Excluir agendamento?")) return;
  DB.agenda = DB.agenda.filter(a=>a.id!==id);
  save(); show("agenda");
}
function addVaccine(){
  const petId = Number($("vpetVac").value);
  if(!petId) return alert("Selecione o pet.");
  const name = $("vname").value.trim();
  if(!name) return alert("Nome da vacina.");

  DB.vaccines.push({
    id:idNow(), shopId:DB.currentShopId,
    petId, name,
    date:$("vdate").value,
    nextDate:$("vnext").value,
    obs:$("vobs").value.trim()
  });
  save(); show("agenda");
}
function delVaccine(id){
  if(!confirm("Excluir vacina?")) return;
  DB.vaccines = DB.vaccines.filter(v=>v.id!==id);
  save(); show("agenda");
}

/** ======================
 * GROOMING FLOW (Fila Banho/Tosa)
 * ====================== */
const GROOM_STEPS = ["Recebido","Banho","Secagem","Tosa","Pronto","Entregue"];
function stepDot(status){
  if(status==="Entregue") return "dot green";
  if(status==="Pronto") return "dot blue";
  if(status==="Recebido") return "dot gray";
  return "dot red";
}
function groom(){
  const pets = shopFilter(DB.pets);
  const clients = shopFilter(DB.clients);
  const items = shopFilter(DB.grooming)
    .slice()
    .sort((a,b)=> b.createdAt - a.createdAt);

  $("screen").innerHTML = `
    <div class="card">
      <h3>Entrar na fila</h3>
      <label>Pet</label>
      <select id="gpet">
        ${pets.length ? pets.map(p=>{
          const c = clients.find(x=>x.id===p.clientId);
          return `<option value="${p.id}">${esc(p.name)} ‚Ä¢ ${esc(c?.name||"")}</option>`;
        }).join("") : `<option value="">Cadastre um pet</option>`}
      </select>
      <label>Servi√ßo</label>
      <select id="gtype">
        <option>Banho</option>
        <option>Tosa</option>
        <option>Banho + Tosa</option>
      </select>
      <label>Observa√ß√£o</label>
      <input id="gnote" placeholder="Ex: n√£o cortar muito curto">
      <div class="actions">
        <button class="primary" onclick="addGroom()">Adicionar</button>
      </div>
      <div class="small">Isso aqui vende demais: o cliente v√™ organiza√ß√£o e fluxo.</div>
    </div>

    <div class="card">
      <h3>Fila (status)</h3>
      ${items.length ? items.map(g=>{
        const p = pets.find(x=>x.id===g.petId);
        const c = p ? clients.find(x=>x.id===p.clientId) : null;
        const idx = GROOM_STEPS.indexOf(g.status);
        const next = idx>=0 && idx < GROOM_STEPS.length-1 ? GROOM_STEPS[idx+1] : null;
        const prev = idx>0 ? GROOM_STEPS[idx-1] : null;

        return `
          <div class="list-item">
            <div class="row" style="align-items:center">
              <span class="${stepDot(g.status)}"></span>
              <div>
                <b>${esc(p?.name||"Pet")}</b>
                <span class="badge">${esc(g.type||"")}</span>
                <span class="badge">${esc(g.status||"")}</span><br>
                <span class="small">${esc(c?.name||"")} ${c?.phone ? "‚Ä¢ "+esc(c.phone) : ""}</span>
                ${g.note ? `<div class="small">${esc(g.note)}</div>` : ``}
              </div>
            </div>

            <div class="actions">
              ${prev ? `<button class="secondary" onclick="setGroomStatus(${g.id}, '${prev}')">Voltar</button>` : ``}
              ${next ? `<button class="primary" onclick="setGroomStatus(${g.id}, '${next}')">Avan√ßar</button>` : ``}
              ${c?.phone ? `<button class="secondary" onclick="waOpen('${esc(c.phone)}', groomMsg('${esc(p?.name||"Pet")}','${esc(g.status||"")}'))">WhatsApp status</button>` : ``}
              <button class="danger" onclick="delGroom(${g.id})">Excluir</button>
            </div>
          </div>
        `;
      }).join("") : `<div class="small">Fila vazia. Quando entrar um pet, ele aparece aqui.</div>`}
    </div>
  `;
}
function groomMsg(pet, status){
  return `üêæ Atualiza√ß√£o do ${pet}\nStatus: ${status}\n\nQualquer coisa, chama aqui.`;
}
function addGroom(){
  const petId = Number($("gpet").value);
  if(!petId) return alert("Selecione um pet.");
  DB.grooming.push({
    id:idNow(), shopId:DB.currentShopId,
    petId,
    type:$("gtype").value,
    status:"Recebido",
    note:$("gnote").value.trim(),
    createdAt: Date.now()
  });
  save(); show("groom");
}
function setGroomStatus(id, status){
  const g = DB.grooming.find(x=>x.id===id);
  if(!g) return;
  g.status = status;
  save(); show("groom");
}
function delGroom(id){
  if(!confirm("Excluir da fila?")) return;
  DB.grooming = DB.grooming.filter(g=>g.id!==id);
  save(); show("groom");
}
function quickGroom(petId, type){
  if(!guard(FEATURES.GROOMING_FLOW, "Fila Banho/Tosa √© PLUS ou acima.")) return;
  DB.grooming.push({
    id:idNow(), shopId:DB.currentShopId,
    petId,
    type: type || "Banho + Tosa",
    status:"Recebido",
    note:"",
    createdAt: Date.now()
  });
  save(); show("groom");
}

/** ======================
 * PRODUCTS + STOCK ALERT
 * ====================== */
function productsUI(){
  const products = shopFilter(DB.products).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  const lowStock = products.filter(p=>{
    const qty = Number((p.qty||"0").replace(",","."));
    const min = Number((p.min||"0").replace(",","."));
    return !isNaN(qty) && !isNaN(min) && qty <= min;
  });

  return `
    <div class="card">
      <h3>Produtos / Estoque</h3>
      <label>Nome</label><input id="pname" placeholder="Ex: Ra√ß√£o 10kg">
      <div class="row">
        <div><label>Pre√ßo</label><input id="pprice" placeholder="Ex: 129,90"></div>
        <div><label>Estoque</label><input id="pqty" placeholder="Ex: 8"></div>
      </div>
      <div class="row">
        <div><label>M√≠nimo (alerta)</label><input id="pmin" placeholder="Ex: 3"></div>
        <div><label>Obs</label><input id="pnotes" placeholder="Marca, validade, etc"></div>
      </div>
      <div class="actions">
        <button class="primary" onclick="addProduct()">Salvar</button>
      </div>
      ${has(FEATURES.STOCK_ALERT) ? `
        <hr>
        <div class="small"><b>Alertas:</b> ${lowStock.length ? lowStock.length+" item(ns) baixo" : "tudo ok"}</div>
      ` : `<div class="small" style="margin-top:10px">Alerta de estoque √© PLUS ou acima.</div>`}
    </div>

    <div class="card">
      <h3>Lista</h3>
      ${products.length ? products.map(p=>`
        <div class="list-item">
          <b>${esc(p.name)}</b>
          <span class="badge">R$ ${esc(p.price||"0")}</span>
          <span class="badge">Qtd ${esc(p.qty||"0")}</span>
          ${has(FEATURES.STOCK_ALERT) ? `<span class="badge">M√≠n ${esc(p.min||"0")}</span>` : ``}
          <div class="small">${p.notes ? esc(p.notes) : ""}</div>
          <div class="actions">
            <button class="secondary" onclick="adjustStock(${p.id}, 1)">+1</button>
            <button class="secondary" onclick="adjustStock(${p.id}, -1)">-1</button>
            <button class="danger" onclick="delProduct(${p.id})">Excluir</button>
          </div>
        </div>
      `).join("") : `<div class="small">Sem produtos ainda.</div>`}
    </div>
  `;
}
function addProduct(){
  const name = $("pname").value.trim();
  if(!name) return alert("Nome do produto.");
  DB.products.push({
    id:idNow(), shopId:DB.currentShopId,
    name,
    price:$("pprice").value.trim(),
    qty:$("pqty").value.trim(),
    min:$("pmin").value.trim(),
    notes:$("pnotes").value.trim()
  });
  save(); show("home");
}
function delProduct(id){
  if(!confirm("Excluir produto?")) return;
  DB.products = DB.products.filter(p=>p.id!==id);
  save(); show("home");
}
function adjustStock(id, delta){
  const p = DB.products.find(x=>x.id===id);
  if(!p) return;
  let q = Number((p.qty||"0").replace(",","."));
  if(isNaN(q)) q = 0;
  q += delta;
  if(q < 0) q = 0;
  p.qty = String(q).replace(".",",");
  save(); show("home");
}

/** ======================
 * VET + PDF/PRINT + WHATSAPP + COMISS√ÉO
 * ====================== */
function vet(){
  const pets = shopFilter(DB.pets);
  const clients = shopFilter(DB.clients);
  if(!pets.length){
    $("screen").innerHTML = `<div class="card"><h3>Veterin√°rio</h3><div class="small">Cadastre um pet primeiro.</div></div>`;
    return;
  }
  const petId = Number(DB.__vetPetId || pets[0].id);
  DB.__vetPetId = petId; save();

  const pet = pets.find(p=>p.id===petId);
  const tutor = clients.find(c=>c.id===pet.clientId);

  const records = shopFilter(DB.vetRecords).filter(r=>r.petId===petId).slice().sort((a,b)=>b.createdAt-a.createdAt);

  $("screen").innerHTML = `
    <div class="card">
      <h3>Atendimento</h3>
      <label>Pet</label>
      <select id="vpetSel" onchange="selectVetPet()">
        ${pets.map(p=>`<option value="${p.id}" ${p.id===petId?"selected":""}>${esc(p.name)}</option>`).join("")}
      </select>

      <div class="row" style="align-items:center;margin-top:10px">
        <img class="avatar" src="${pet.photo||""}" alt="" onerror="this.style.display='none'">
        <div class="small">
          <b>${esc(pet.name)}</b> ‚Ä¢ ${esc(pet.species||"")} ${pet.breed ? "‚Ä¢ "+esc(pet.breed) : ""}<br>
          Tutor: ${esc(tutor?.name||"")} ${tutor?.phone ? "‚Ä¢ "+esc(tutor.phone) : ""}
        </div>
      </div>

      <hr>

      <div class="row">
        <div><label>Peso (kg)</label><input id="vweight" placeholder="Ex: 12,4"></div>
        <div><label>Temperatura</label><input id="vtemp" placeholder="Ex: 38,9"></div>
      </div>

      <label>Anamnese</label><textarea id="vanam"></textarea>
      <label>Diagn√≥stico</label><textarea id="vdiag"></textarea>
      <label>Receita</label><textarea id="vmed" placeholder="Dose, intervalo, dura√ß√£o"></textarea>
      <label>Procedimentos</label><textarea id="vproc"></textarea>

      <div class="row">
        <div><label>Retorno</label><input id="vreturn" type="date"></div>
        <div><label>Valor</label><input id="vvalue" placeholder="Ex: 120,00"></div>
      </div>

      <div class="row">
        <div>
          <label>Veterin√°rio</label>
          <input id="vdoc" placeholder="Nome do veterin√°rio">
        </div>
        <div>
          <label>Comiss√£o (%)</label>
          <input id="vcomm" placeholder="Ex: 30" ${has(FEATURES.COMMISSION) ? "" : "disabled"}>
          ${has(FEATURES.COMMISSION) ? "" : `<div class="small">Comiss√£o √© PLUS ou acima.</div>`}
        </div>
      </div>

      <div class="actions">
        <button class="primary" onclick="saveVetRecord()">Salvar atendimento</button>
        <button class="secondary" onclick="printPrescriptionGuarded()">Imprimir / PDF</button>
        ${tutor?.phone ? `<button class="secondary" onclick="sendWhatsAppReceiptGuarded('${esc(tutor.phone)}')">WhatsApp receita</button>` : ``}
      </div>
    </div>

    <div class="card">
      <h3>Hist√≥rico</h3>
      ${records.length ? records.map(r=>`
        <div class="list-item">
          <b>${new Date(r.createdAt).toLocaleString("pt-BR")}</b>
          ${r.value ? `<span class="badge">R$ ${esc(r.value)}</span>` : ``}
          ${r.weight ? `<span class="badge">${esc(r.weight)} kg</span>` : ``}
          ${r.returnDate ? `<span class="badge">Retorno: ${esc(r.returnDate)}</span>` : ``}
          ${r.vet ? `<span class="badge">${esc(r.vet)}</span>` : ``}
          ${r.commValue ? `<span class="badge">Comiss√£o: R$ ${esc(r.commValue)}</span>` : ``}

          <div class="small" style="margin-top:6px">
            ${r.anam ? `<div><b>Anamnese:</b> ${esc(r.anam)}</div>` : ``}
            ${r.diag ? `<div><b>Diagn√≥stico:</b> ${esc(r.diag)}</div>` : ``}
            ${r.med ? `<div><b>Receita:</b> ${esc(r.med)}</div>` : ``}
            ${r.proc ? `<div><b>Procedimentos:</b> ${esc(r.proc)}</div>` : ``}
          </div>

          <div class="actions">
            <button class="secondary" onclick="openRecord(${r.id})">Abrir</button>
            <button class="danger" onclick="delVetRecord(${r.id})">Excluir</button>
          </div>
        </div>
      `).join("") : `<div class="small">Sem atendimentos ainda.</div>`}
    </div>
  `;
}
function selectVetPet(){
  DB.__vetPetId = Number($("vpetSel").value);
  save(); show("vet");
}
function goVet(petId){
  DB.__vetPetId = petId;
  save(); show("vet");
}
function saveVetRecord(){
  const petId = Number(DB.__vetPetId);
  const weight = $("vweight").value.trim();
  const temp = $("vtemp").value.trim();
  const anam = $("vanam").value.trim();
  const diag = $("vdiag").value.trim();
  const med = $("vmed").value.trim();
  const proc = $("vproc").value.trim();
  const returnDate = $("vreturn").value;
  const value = $("vvalue").value.trim();
  const vet = $("vdoc").value.trim();
  const comm = $("vcomm") ? $("vcomm").value.trim() : "";

  const hasAny = weight||temp||anam||diag||med||proc||returnDate||value||vet||comm;
  if(!hasAny) return alert("Escreva algo antes de salvar.");

  let commValue = "";
  if(has(FEATURES.COMMISSION)){
    const v = Number((value||"").replace(".","").replace(",","."));
    const c = Number((comm||"").replace(",","."));
    if(!isNaN(v) && !isNaN(c) && v>0 && c>0) commValue = fmt(v*(c/100));
  }

  DB.vetRecords.push({
    id:idNow(), shopId:DB.currentShopId,
    petId, createdAt:Date.now(),
    weight, temp, anam, diag, med, proc, returnDate,
    value, vet, comm, commValue
  });

  if(has(FEATURES.CASH) && value){
    DB.cashflow.push({
      id:idNow(), shopId:DB.currentShopId,
      date: todayISO(),
      type:"in",
      value,
      desc: `Atendimento vet ‚Ä¢ ${petName(petId)}`
    });
  }

  save(); show("vet");
}
function delVetRecord(id){
  if(!confirm("Excluir atendimento?")) return;
  DB.vetRecords = DB.vetRecords.filter(r=>r.id!==id);
  save(); show("vet");
}
function openRecord(id){
  const r = DB.vetRecords.find(x=>x.id===id);
  if(!r) return;
  $("vweight").value = r.weight||"";
  $("vtemp").value = r.temp||"";
  $("vanam").value = r.anam||"";
  $("vdiag").value = r.diag||"";
  $("vmed").value = r.med||"";
  $("vproc").value = r.proc||"";
  $("vreturn").value = r.returnDate||"";
  $("vvalue").value = r.value||"";
  $("vdoc").value = r.vet||"";
  if($("vcomm")) $("vcomm").value = r.comm||"";
  window.scrollTo({top:0, behavior:"smooth"});
}
function printPrescriptionGuarded(){
  if(!guard(FEATURES.PDF, "Imprimir/PDF √© PRO ou acima.")) return;
  printPrescription();
}
function printPrescription(){
  const pets = shopFilter(DB.pets);
  const clients = shopFilter(DB.clients);
  const pet = pets.find(p=>p.id===Number(DB.__vetPetId));
  const tutor = pet ? clients.find(c=>c.id===pet.clientId) : null;

  const med = $("vmed")?.value?.trim() || "";
  const diag = $("vdiag")?.value?.trim() || "";
  const proc = $("vproc")?.value?.trim() || "";
  const vet = $("vdoc")?.value?.trim() || "Veterin√°rio";
  const shop = currentShop();

  const html = `
    <div style="font-family:Arial; padding:18px">
      <h2 style="margin:0 0 6px 0">${esc(shop.name)}</h2>
      ${shop.phone ? `<div>${esc(shop.phone)}</div>` : ``}
      <hr>
      <h3 style="margin:10px 0">Receita / Orienta√ß√µes</h3>

      <div><b>Pet:</b> ${esc(pet?.name||"")}</div>
      <div><b>Tutor:</b> ${esc(tutor?.name||"")} ${tutor?.phone ? " ‚Ä¢ "+esc(tutor.phone) : ""}</div>
      <div><b>Data:</b> ${new Date().toLocaleDateString("pt-BR")}</div>
      <div><b>Veterin√°rio:</b> ${esc(vet)}</div>

      <hr>

      ${diag ? `<div><b>Diagn√≥stico:</b><br>${esc(diag).replace(/\n/g,"<br>")}</div><br>` : ``}
      ${med ? `<div><b>Receita:</b><br>${esc(med).replace(/\n/g,"<br>")}</div><br>` : ``}
      ${proc ? `<div><b>Procedimentos / Orienta√ß√µes:</b><br>${esc(proc).replace(/\n/g,"<br>")}</div><br>` : ``}

      <hr>
      <div style="margin-top:22px">Assinatura: _______________________________________</div>
    </div>
  `;
  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}
function sendWhatsAppReceiptGuarded(phone){
  if(!guard(FEATURES.WHATSAPP, "WhatsApp autom√°tico √© PRO ou acima.")) return;
  sendWhatsAppReceipt(phone);
}
function sendWhatsAppReceipt(phone){
  const pets = shopFilter(DB.pets);
  const pet = pets.find(p=>p.id===Number(DB.__vetPetId));
  const med = $("vmed")?.value?.trim() || "";
  const diag = $("vdiag")?.value?.trim() || "";
  const ret = $("vreturn")?.value || "";

  let msg = `üêæ Receita do ${pet?.name||"pet"}\n\n`;
  if(diag) msg += `Diagn√≥stico:\n${diag}\n\n`;
  if(med) msg += `Receita:\n${med}\n\n`;
  if(ret) msg += `Retorno: ${ret}\n\n`;
  msg += `Qualquer coisa, chama aqui.`;

  waOpen(phone, msg);
}

/** ======================
 * HOTEL
 * ====================== */
function hotel(){
  const pets = shopFilter(DB.pets);
  const clients = shopFilter(DB.clients);
  const items = shopFilter(DB.boardings).slice().sort((a,b)=> (b.inDate||"").localeCompare(a.inDate||""));

  $("screen").innerHTML = `
    <div class="card">
      <h3>Nova hospedagem</h3>
      <label>Pet</label>
      <select id="hpet">
        ${pets.length ? pets.map(p=>{
          const c = clients.find(x=>x.id===p.clientId);
          return `<option value="${p.id}" ${Number(DB.__hotelPetId||0)===p.id?"selected":""}>${esc(p.name)} ‚Ä¢ ${esc(c?.name||"")}</option>`;
        }).join("") : `<option value="">Cadastre um pet</option>`}
      </select>
      <div class="row">
        <div><label>Entrada</label><input id="hin" type="date" value="${todayISO()}"></div>
        <div><label>Sa√≠da prevista</label><input id="hout" type="date"></div>
      </div>
      <div class="row">
        <div><label>Di√°ria (R$)</label><input id="hdaily" placeholder="Ex: 50,00"></div>
        <div><label>Status</label><select id="hstatus"><option>Ativo</option><option>Finalizado</option></select></div>
      </div>
      <label>Medica√ß√£o / Rotina</label>
      <textarea id="hmeds" placeholder="Hor√°rios, ra√ß√£o, cuidados"></textarea>
      <label>Observa√ß√µes</label>
      <input id="hobs" placeholder="Temperamento, banho, etc">
      <div class="actions">
        <button class="primary" onclick="addBoarding()">Salvar</button>
      </div>
    </div>

    <div class="card">
      <h3>Hospedagens</h3>
      ${items.length ? items.map(b=>{
        const p = pets.find(x=>x.id===b.petId);
        const c = p ? clients.find(x=>x.id===p.clientId) : null;
        return `
          <div class="list-item">
            <b>${esc(p?.name||"Pet")}</b> <span class="badge">${esc(b.status||"")}</span><br>
            <span class="small">${esc(c?.name||"")} ‚Ä¢ Entrada: ${esc(b.inDate||"")} ${b.outDate? "‚Ä¢ Sa√≠da: "+esc(b.outDate):""}</span>
            ${b.daily ? `<div class="small">Di√°ria: R$ ${esc(b.daily)}</div>` : ``}
            ${b.meds ? `<div class="small"><b>Rotina:</b> ${esc(b.meds)}</div>` : ``}
            ${b.obs ? `<div class="small">${esc(b.obs)}</div>` : ``}
            <div class="actions">
              ${has(FEATURES.WHATSAPP) && c?.phone ? `<button class="secondary" onclick="waOpen('${esc(c.phone)}', 'üêæ Atualiza√ß√£o do ${esc(p?.name||"pet")}\\nStatus: ${esc(b.status||"Ativo")}')">WhatsApp status</button>` : ``}
              <button class="danger" onclick="delBoarding(${b.id})">Excluir</button>
            </div>
          </div>
        `;
      }).join("") : `<div class="small">Nenhuma hospedagem registrada.</div>`}
    </div>
  `;
}
function goHotel(petId){
  DB.__hotelPetId = petId;
  save(); show("hotel");
}
function addBoarding(){
  const petId = Number($("hpet").value);
  if(!petId) return alert("Selecione um pet.");
  const inDate = $("hin").value;
  if(!inDate) return alert("Entrada obrigat√≥ria.");

  DB.boardings.push({
    id:idNow(), shopId:DB.currentShopId,
    petId,
    inDate,
    outDate:$("hout").value,
    daily:$("hdaily").value.trim(),
    status:$("hstatus").value,
    meds:$("hmeds").value.trim(),
    obs:$("hobs").value.trim()
  });
  save(); show("hotel");
}
function delBoarding(id){
  if(!confirm("Excluir hospedagem?")) return;
  DB.boardings = DB.boardings.filter(b=>b.id!==id);
  save(); show("hotel");
}

/** ======================
 * CASH / SALES (Caixa)
 * ====================== */
function cash(){
  const pets = shopFilter(DB.pets);
  const sales = shopFilter(DB.sales).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
  const cashflow = shopFilter(DB.cashflow).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  $("screen").innerHTML = `
    <div class="card">
      <h3>Venda r√°pida</h3>
      <label>Item (produto/servi√ßo)</label>
      <input id="sitem" placeholder="Ex: Banho, Ra√ß√£o 10kg">
      <div class="row">
        <div><label>Valor</label><input id="svalue" placeholder="Ex: 80,00"></div>
        <div><label>Pagamento</label>
          <select id="spay"><option>Dinheiro</option><option>Pix</option><option>Cart√£o</option></select>
        </div>
      </div>
      <label>Pet (opcional)</label>
      <select id="spet">
        <option value="">---</option>
        ${pets.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join("")}
      </select>
      <label>Obs</label>
      <input id="sobs" placeholder="Ex: desconto, fiado, etc">
      <div class="actions">
        <button class="primary" onclick="addSale()">Registrar</button>
      </div>
    </div>

    <div class="card">
      <h3>Entradas / Sa√≠das</h3>
      <div class="row">
        <div>
          <label>Tipo</label>
          <select id="ctype"><option value="in">Entrada</option><option value="out">Sa√≠da</option></select>
        </div>
        <div><label>Valor</label><input id="cvalue" placeholder="Ex: 50,00"></div>
      </div>
      <label>Descri√ß√£o</label><input id="cdesc" placeholder="Ex: compra de ra√ß√£o">
      <div class="actions"><button class="primary" onclick="addCashflow()">Salvar</button></div>
      <hr>
      ${cashflow.slice(0,10).map(c=>`
        <div class="list-item">
          <b>${c.type==="in"?"Entrada":"Sa√≠da"}</b> <span class="badge">${esc(c.date)}</span>
          <span class="badge">R$ ${esc(c.value)}</span><br>
          <span class="small">${esc(c.desc||"")}</span>
          <div class="actions"><button class="danger" onclick="delCashflow(${c.id})">Excluir</button></div>
        </div>
      `).join("") || `<div class="small">Sem lan√ßamentos.</div>`}
    </div>

    <div class="card">
      <h3>Vendas recentes</h3>
      ${sales.slice(0,10).map(s=>`
        <div class="list-item">
          <b>R$ ${esc(s.total)}</b> <span class="badge">${esc(s.date)}</span> <span class="badge">${esc(s.pay)}</span><br>
          <span class="small">${esc(s.items?.[0]?.name||"")}${s.petId ? " ‚Ä¢ "+esc(petName(s.petId)) : ""}</span>
          ${s.obs ? `<div class="small">${esc(s.obs)}</div>` : ``}
          <div class="actions"><button class="danger" onclick="delSale(${s.id})">Excluir</button></div>
        </div>
      `).join("") || `<div class="small">Sem vendas.</div>`}
    </div>
  `;
}
function addSale(){
  const item = $("sitem").value.trim();
  const value = $("svalue").value.trim();
  if(!item || !value) return alert("Item e valor.");
  const sale = {
    id:idNow(), shopId:DB.currentShopId,
    date: todayISO(),
    items:[{name:item, value}],
    total:value,
    pay:$("spay").value,
    petId: $("spet").value ? Number($("spet").value) : null,
    obs:$("sobs").value.trim()
  };
  DB.sales.push(sale);
  DB.cashflow.push({ id:idNow(), shopId:DB.currentShopId, date: todayISO(), type:"in", value, desc:`Venda ‚Ä¢ ${item}` });
  save(); show("cash");
}
function delSale(id){
  if(!confirm("Excluir venda?")) return;
  DB.sales = DB.sales.filter(s=>s.id!==id);
  save(); show("cash");
}
function addCashflow(){
  const type = $("ctype").value;
  const value = $("cvalue").value.trim();
  const desc = $("cdesc").value.trim();
  if(!value || !desc) return alert("Valor e descri√ß√£o.");
  DB.cashflow.push({id:idNow(), shopId:DB.currentShopId, date: todayISO(), type, value, desc});
  save(); show("cash");
}
function delCashflow(id){
  if(!confirm("Excluir lan√ßamento?")) return;
  DB.cashflow = DB.cashflow.filter(c=>c.id!==id);
  save(); show("cash");
}

/** ======================
 * PORTAL DO TUTOR
 * ====================== */
function portal(){
  $("screen").innerHTML = `
    <div class="card">
      <h3>Portal do Tutor</h3>
      <label>Telefone do tutor</label>
      <input id="psearch" placeholder="Ex: 6799..." value="${esc(DB.__portalPhone||"")}">
      <div class="actions"><button class="primary" onclick="searchTutor()">Buscar</button></div>
      <div id="presult" style="margin-top:10px"></div>
      <div class="small">Isso aqui √© argumento de venda forte: ‚Äúo cliente v√™ o hist√≥rico e confia na loja‚Äù.</div>
    </div>
  `;
}
function searchTutor(){
  const phone = $("psearch").value.trim();
  DB.__portalPhone = phone; save();

  const clients = shopFilter(DB.clients);
  const pets = shopFilter(DB.pets);
  const agenda = shopFilter(DB.agenda);
  const vet = shopFilter(DB.vetRecords);
  const vac = shopFilter(DB.vaccines);

  const c = clients.find(c=> (c.phone||"").includes(phone));
  if(!c){ $("presult").innerHTML = `<div class="small">N√£o encontrado.</div>`; return; }

  const myPets = pets.filter(p=>p.clientId===c.id);
  const petIds = myPets.map(p=>p.id);
  const upcoming = agenda.filter(a=> petIds.includes(a.petId)).slice().sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time)).slice(0,10);
  const lastVet = vet.filter(r=> petIds.includes(r.petId)).slice().sort((a,b)=> b.createdAt-a.createdAt).slice(0,8);
  const myVac = vac.filter(v=> petIds.includes(v.petId)).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||"")).slice(0,10);

  $("presult").innerHTML = `
    <div class="card" style="margin:0">
      <b>${esc(c.name)}</b> <span class="badge">${esc(c.phone||"")}</span>
      <div class="actions">
        ${has(FEATURES.WHATSAPP) && c.phone ? `<button class="secondary" onclick="waOpen('${esc(c.phone)}','Ol√°! üòä')">WhatsApp</button>` : ``}
      </div>
      <hr>

      <h3 style="margin:0 0 10px 0">Pets</h3>
      ${myPets.map(p=>`
        <div class="list-item">
          <div class="row" style="align-items:center">
            <img class="avatar" src="${p.photo||""}" alt="" onerror="this.style.display='none'">
            <div>
              <b>${esc(p.name)}</b> <span class="badge">${esc(p.species||"")}</span><br>
              <span class="small">${p.breed?esc(p.breed):""} ${p.allergy? "‚Ä¢ alergia: "+esc(p.allergy):""}</span>
            </div>
          </div>
        </div>
      `).join("") || `<div class="small">Sem pets.</div>`}

      <hr>
      <h3 style="margin:0 0 10px 0">Vacinas</h3>
      ${myVac.map(v=>`
        <div class="list-item">
          <b>${esc(v.name)}</b> <span class="badge">${esc(v.date||"")}</span>
          ${v.nextDate ? `<span class="badge">Pr√≥xima: ${esc(v.nextDate)}</span>` : ``}
          <div class="small">${esc(petName(v.petId))}</div>
        </div>
      `).join("") || `<div class="small">Sem vacinas registradas.</div>`}

      <hr>
      <h3 style="margin:0 0 10px 0">Pr√≥ximos agendamentos</h3>
      ${upcoming.map(a=>`
        <div class="list-item">
          <b>${esc(a.type)}</b> <span class="badge">${esc(a.date)} ${esc(a.time||"")}</span><br>
          <span class="small">${esc(petName(a.petId))}</span>
        </div>
      `).join("") || `<div class="small">Nada agendado.</div>`}

      ${has(FEATURES.VET) ? `
        <hr>
        <h3 style="margin:0 0 10px 0">√öltimos atendimentos</h3>
        ${lastVet.map(r=>`
          <div class="list-item">
            <b>${esc(petName(r.petId))}</b> <span class="badge">${new Date(r.createdAt).toLocaleDateString("pt-BR")}</span>
            ${r.diag ? `<div class="small"><b>Diag:</b> ${esc(r.diag)}</div>` : ``}
            ${r.med ? `<div class="small"><b>Receita:</b> ${esc(r.med)}</div>` : ``}
          </div>
        `).join("") || `<div class="small">Sem atendimentos.</div>`}
      ` : ``}
    </div>
  `;
}

/** ======================
 * INIT
 * ====================== */
(function init(){
  renderNav();
  show("home");

  // coloca Produtos/Estoque dentro da Home sempre (argumento de venda)
  const oldHome = home;
  home = function(){
    oldHome();
    if(has(FEATURES.PRODUCTS)){
      $("screen").innerHTML = $("screen").innerHTML + productsUI();
    }
  };
  show("home");
})();
</script>
</body>
</html>
